/**
 * open-nof1.ai - AI 加密货币自动交易系统
 * Copyright (C) 2025 195440
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 * 
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see <https://www.gnu.org/licenses/>.
 */

import type { StrategyParams, StrategyPromptContext } from "./types";

/**
 * Alpha Beta 策略配置
 * 
 * 核心设计理念：
 * - 30分钟检查周期，但关注更长时间框架
 * - 突破点位触发机制
 * - 无持仓：设置预警价位，突破后再决策
 * - 有持仓：设置持仓突破点位，突破后再决策
 * - 交易大师经验指导
 * - 双重防护机制（代码级自动保护 + 主动决策）
 * 
 * 核心特点：
 * - 30分钟检查，但分析1小时/4小时时间框架，避免短期噪音
 * - 关键价位突破触发机制
 * - 提供专业交易大师的经验指导
 * - 信号评分≥75分才开仓
 * - 目标收益≥5%
 * - 严格风控机制
 * 
 * @param maxLeverage - 系统允许的最大杠杆倍数（从配置文件读取）
 * @returns Alpha Beta 策略的完整参数配置
 */
export function getAlphaBetaStrategy(maxLeverage: number): StrategyParams {
  return {
    // ==================== 策略基本信息 ====================
    name: "Alpha Beta",
    description: "低频交易，30分钟检查，关注1H/4H趋势，突破点位触发",
    
    // ==================== 杠杆配置 ====================
    // 杠杆范围：1倍到最大杠杆，由AI完全自主选择
    leverageMin: 1,
    leverageMax: maxLeverage,
    leverageRecommend: {
      normal: "完全由 AI 自主决定",
      good: "完全由 AI 自主决定",
      strong: "完全由 AI 自主决定",
    },
    
    // ==================== 仓位配置 ====================
    // 仓位范围：1-50%，单笔最大50%，总持仓保证金不超过50%
    // 由AI在此范围内自主选择，确保风险可控
    positionSizeMin: 1,
    positionSizeMax: 50,  // 单笔最大50%，避免过度集中风险
    maxTotalMarginPercent: 50,  // 所有持仓总保证金不超过50%
    positionSizeRecommend: {
      normal: "8-10%（良好信号，75-80分）",
      good: "10-15%（优秀信号，80-90分）",
      strong: "15-20%（完美信号，90-110分）",
    },
    
    // ==================== 止损配置 ====================
    // 代码级自动止损配置（作为安全网）
    // AI主动止损-3%，这些是代码级最后防线（比AI主动止损宽松一些）
    stopLoss: {
      low: -5,    // 低杠杆（1-5倍）：亏损5%时代码自动止损
      mid: -4,    // 中杠杆（6-10倍）：亏损4%时代码自动止损
      high: -3.5, // 高杠杆（11倍以上）：亏损3.5%时代码自动止损
    },
    
    // ==================== 移动止盈配置 ====================
    // 代码级自动移动止盈配置（作为利润保护网）
    // AI可以在此之前主动止盈，这些是自动保护机制
    trailingStop: {
      level1: { trigger: 5, stopAt: 2 },     // 盈利5%时，止损线移至+2%
      level2: { trigger: 10, stopAt: 5 },    // 盈利10%时，止损线移至+5%
      level3: { trigger: 15, stopAt: 10 },   // 盈利15%时，止损线移至+10%
    },
    
    // ==================== 分批止盈配置 ====================
    // 代码级自动分批止盈配置（作为利润锁定机制）
    // AI可以在此之前主动止盈，这些是自动锁利机制
    // 低频策略，设置更现实的止盈目标
    partialTakeProfit: {
      stage1: { trigger: 10, closePercent: 40 },   // 盈利10%时，自动平仓40%（锁定核心利润）
      stage2: { trigger: 18, closePercent: 40 },   // 盈利18%时，自动平仓40%（保守第二目标）
      stage3: { trigger: 30, closePercent: 20 },   // 盈利30%时，自动平仓剩余20%（终极目标）
    },
    
    // ==================== 峰值回撤保护 ====================
    // 代码级峰值回撤保护（防止利润大幅回吐）
    peakDrawdownProtection: 50,  // 从峰值回撤50%时提醒AI注意
    
    // ==================== 波动率调整 ====================
    // 不进行波动率调整，由AI自主判断
    volatilityAdjustment: {
      highVolatility: { 
        leverageFactor: 1.0,
        positionFactor: 1.0
      },
      normalVolatility: { 
        leverageFactor: 1.0,
        positionFactor: 1.0
      },
      lowVolatility: { 
        leverageFactor: 1.0,
        positionFactor: 1.0
      },
    },
    
    // ==================== 策略规则描述 ====================
    entryCondition: "完全由 AI 根据市场数据自主判断，无任何预设条件",
    riskTolerance: "完全由 AI 根据市场情况自主决定风险承受度，无任何限制",
    tradingStyle: "完全由 AI 根据市场机会自主决定交易风格和频率，鼓励探索和学习",
    
    // ==================== 代码级保护开关 ====================
    // 启用代码级保护（每10秒自动监控止损止盈）
    enableCodeLevelProtection: true,
    
    // ==================== 双重防护模式 ====================
    // 允许AI在代码级保护之外继续主动操作止盈止损
    // 核心设计：代码保护是安全网，AI有完全主动权
    allowAiOverrideProtection: true,
  };
}

/**
 * 生成 Alpha Beta 策略特有的提示词
 * 
 * 提示词设计原则：
 * - 不提供任何策略建议
 * - 只提供市场数据和工具说明
 * - 强制自我复盘机制
 * - 强调双重防护机制
 * 
 * @param params - 策略参数配置（从 getAlphaBetaStrategy 获得）
 * @param context - 运行时上下文（包含执行周期、持仓数量等）
 * @returns Alpha Beta 策略专属的AI提示词
 */
export function generateAlphaBetaPrompt(
  params: StrategyParams, 
  context: StrategyPromptContext
): string {
  return `
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【Alpha Beta 策略 - 30分钟检查周期】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**策略核心**：
- 每30分钟检查一次，但关注**1小时和4小时**的趋势
- 不追逐短期波动，等待高质量机会
- 信号评分≥75分才开仓
- 目标收益≥5%，严格止损-3%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【一、时间框架分析】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**主要分析时间框架**（从大到小）：
- **4小时图（趋势确认）**：确认大级别趋势方向，最重要
- **1小时图（主要框架）**：判断中期趋势，主要决策依据
- **30分钟图（当前周期）**：观察短期走势，但不追逐波动
- **15分钟图（入场时机）**：寻找具体入场点位，仅用于入场

**核心原则**：30分钟检查一次，但必须看1小时和4小时的趋势！

**趋势判断标准**：
✅ **明确上升趋势**（做多条件）：
   - 1H/4H 价格 > EMA20 > EMA50
   - EMA均线呈多头排列（短期均线在上）
   - MACD持续为正或刚转正
   - 价格回踩EMA20不破，形成更高的低点

✅ **明确下降趋势**（做空条件）：
   - 1H/4H 价格 < EMA20 < EMA50
   - EMA均线呈空头排列（短期均线在下）
   - MACD持续为负或刚转负
   - 价格反弹至EMA20受阻，形成更低的高点

⚠️ **震荡区间**（不交易）：
   - 价格在EMA20上下反复穿梭
   - MACD在零轴附近摆动
   - 无明确方向 → 保持观望

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【二、突破点位机制】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**核心原则**：不预测，只跟随。等待市场突破关键位后再决策。

**无持仓时 - 预警价位设置**：

每30分钟检查市场，基于1小时/4小时趋势识别关键价位：

1. **关键阻力位**（突破做多）：
   - 前期高点/平台整理区上沿
   - 重要心理关口（如BTC 100,000）
   - 4小时/日线级别的EMA20/50
   - 布林带上轨位置
   
2. **关键支撑位**（跌破做空）：
   - 前期低点/平台整理区下沿
   - 重要心理关口
   - 4小时/日线级别的EMA20/50
   - 布林带下轨位置

3. **预警位设置原则**：
   - 选择**离当前价格3-5%**的关键位
   - 不要设置太近（1-2%）的位置，避免假突破
   - 预警位必须有技术意义（均线/前高前低/心理关口）

**预警位输出格式**：

  【预警价位设置】
  BTCUSDT 当前价格：$95,500
  - 上方阻力：$98,000（+2.6%，前高位，突破考虑做多）
  - 下方支撑：$92,000（-3.7%，4H EMA50，跌破考虑做空）
  - 观望理由：当前处于震荡区间，等待方向选择
  
  ETHUSDT 当前价格：$3,420
  - 上方阻力：$3,550（+3.8%，日线EMA20，突破考虑做多）
  - 观望理由：上升趋势中，等待回踩支撑或突破阻力

**有持仓时 - 持仓突破点位**：

开仓后立即设置三个关键点位：

1. **止盈点位**（目标收益位）：
   - 保守目标：+5-8%（接近下一个阻力位）
   - 激进目标：+10-15%（趋势延续目标位）
   - 设置在关键阻力/支撑位附近

2. **止损点位**（风险控制位）：
   - 最大止损：-3%（严格执行）
   - 设置在关键支撑/阻力位下方/上方0.5%
   - 止损触发必须立即执行，不犹豫

3. **趋势反转位**（信号变化位）：
   - MACD死叉/金叉位置
   - 价格跌破/突破1H EMA20
   - 成交量异常变化

**持仓突破点位输出格式**：

  【持仓突破点位】
  持仓：BTCUSDT LONG @ $95,000
  当前价格：$96,200（+1.26%）
  
  - 止盈点位 1：$98,500（+3.68%，前高阻力）← 平仓50%
  - 止盈点位 2：$101,000（+6.32%，心理关口）← 平仓剩余
  - 止损点位：$92,000（-3.16%，4H EMA50下方）
  - 趋势反转位：$94,500（-0.53%，1H EMA20，跌破则观察止损）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【三、入场信号评分系统】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**开仓条件：信号评分必须 ≥ 75分**
**震荡市环境：信号评分必须 ≥ 80分**

**评分标准（总分110分，震荡市需≥80分）**：

**1. 趋势确认（30分）**
- 1H/4H/日线三个时间框架趋势一致：30分
- 两个时间框架一致，一个震荡：18分
- 两个时间框架一致，一个相反：8分
- 趋势不一致或震荡：0分

**2. 突破确认（25分）**
- 有效突破（收盘价突破+成交量>200%+突破幅度>1%）：25分
- 突破+成交量放大但幅度不足（<1%）：15分
- 突破但成交量不足（<150%）：10分
- 接近但未突破关键位：5分
- 无明确突破：0分

  **突破有效性判断标准**：
  ✅ 收盘价突破关键位（不能只是盘中穿刺）
  ✅ 突破幅度≥1%（避免假突破）
  ✅ 成交量≥平均值200%（确认资金参与）
  ✅ 突破后15分钟内不回落（确认强度）

**3. 技术指标配合（20分）**
- MACD方向+RSI区间+EMA排列全部支持：20分
- 两项支持：12分
- 一项支持：5分
- 不支持：0分

**4. 成交量确认（10分）**
- 当前成交量 > 平均成交量150%：10分
- 当前成交量 > 平均成交量100%：6分
- 成交量正常：3分
- 成交量萎缩：0分

**5. 流动性评估（10分）**（新增）
- 订单簿深度充足（买卖盘1%深度>50万U）：10分
- 订单簿深度一般（买卖盘1%深度20-50万U）：6分
- 订单簿深度较浅（买卖盘1%深度<20万U）：2分
- 流动性不足（存在滑点风险）：0分

**6. 市场情绪指标（10分）**（新增）
- 资金费率与方向一致（做多时费率负/做空时费率正）：10分
- 资金费率中性（±0.01%以内）：6分
- 资金费率与方向相反但不极端（<0.05%）：3分
- 资金费率极端相反（>0.1%，警示拥挤交易）：0分

**7. 风险回报比（5分）**（权重降低）
- 盈亏比 > 3:1（潜在盈利10%，止损3%）：5分
- 盈亏比 2-3:1：3分
- 盈亏比 1.5-2:1：1分
- 盈亏比 < 1.5:1：0分

**评分输出格式**（必须严格执行）：

  【入场信号评分】
  1. 趋势确认：30/30分
     - 1H: 上升趋势 ✓
     - 4H: 上升趋势 ✓
     - 日线: 上升趋势 ✓
  
  2. 突破确认：25/25分
     - 价格突破$98,000阻力位 ✓
     - 成交量较平均值增加180% ✓
     - 突破K线为阳线收盘 ✓
  
  3. 技术指标：20/20分
     - MACD: 金叉向上 ✓
     - RSI: 55（中性偏多）✓
     - EMA: 多头排列 ✓
  
  4. 成交量：10/10分
     - 当前成交量为平均值的180% ✓
  
  5. 流动性评估：10/10分
     - 订单簿1%深度：买盘80万U，卖盘75万U ✓
  
  6. 市场情绪：10/10分
     - 资金费率：-0.005%（略负，利于做多）✓
  
  7. 风险回报比：5/5分
     - 目标止盈: +10% ($107,800)
     - 止损位: -3% ($95,060)
     - 盈亏比: 3.3:1 ✓
  
  【总分：110/110分】✅ 满足开仓条件（≥75分，完美信号）
  市场环境：牛市，满足开仓条件

**评分不足的处理**：
❌ < 75分：不开仓，继续观望
❌ 震荡市<80分：不开仓，等待更好的机会
❌ 重新设置预警价位
❌ 等待信号改善

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【四、仓位管理】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**动态仓位管理公式**：
仓位金额 = 账户总资金 × 仓位比例

**仓位比例分级**（基于110分制）：

**评分 95-110分（完美信号）**：
- 仓位比例：15-20%
- 杠杆：2-3倍
- 特征：所有条件完美对齐，千载难逢机会

**评分 85-95分（优秀信号）**：
- 仓位比例：12-15%
- 杠杆：2-3倍
- 特征：大部分条件满足，高胜算

**评分 75-85分（良好信号）**：
- 仓位比例：8-12%
- 杠杆：2倍
- 特征：基本条件满足，值得一试

**评分 < 75分（或震荡市<80分）**：
- 不开仓，继续观望

**仓位计算示例**：

  【仓位计算】
  账户总资金：1,000 USDT
  信号评分：92分（优秀信号）
  市场环境：牛市（无需降低仓位）
  仓位比例：14%
  仓位金额：1,000 × 14% = 140 USDT
  杠杆选择：2倍
  实际开仓金额：140 USDT（控制风险）

**重要原则**：
- 单笔建议最大仓位20%（系统允许最大50%，但不建议过大）
- 所有持仓总保证金不超过50%（代码级硬限制）
- 账户增长时，仓位自动增加（复利效应）

**连续亏损保护机制**：
- 连续亏损2次：下一笔仓位降至原计划的70%
- 连续亏损3次：下一笔仓位降至原计划的50%，杠杆降至最高2倍
- 连续亏损4次：暂停交易1个周期，重新评估策略
- 单日亏损达到-5%：当日停止开新仓

**胜率跟踪与调整**：
- 最近10笔胜率<40%：降低仓位至原计划80%，提高开仓门槛至80分
- 最近10笔胜率>65%：可适当提高仓位至原计划110%（不超过最大限制）
- 周期性复盘：每20笔交易后，分析亏损原因，调整策略参数

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【五、持仓管理】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**止损原则（严格执行）**：
1. **永远设置止损**：开仓即设置，-3%止损是底线
2. **果断止损**：触及止损价格立即执行，不幻想反转
3. **移动止损**：盈利达到+5%后，止损移至保本位

**止盈原则（分批获利）**：
1. **达到第一目标（+5-8%）**：平仓50%，锁定利润
2. **达到第二目标（+10-15%）**：平仓剩余30%
3. **趋势延续**：剩余20%设置移动止盈，让利润奔跑

**持仓时间原则**：
- **最小持仓时间**：2小时（给趋势足够发展时间）
- **最大持仓时间**：${context.maxHoldingHours}小时（释放资金）
- **例外情况**：
  ✅ 触及止损/止盈点位可提前平仓
  ✅ 趋势明确反转可提前平仓
  ✅ 重大突发事件可提前平仓

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【六、多空平衡】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**重要提醒：做多和做空是平等的机会**

永续合约做空非常简单，和做多一样容易，不要有心理障碍。

**做多信号**：
✅ 上升趋势 + 价格回踩支撑不破 + 成交量放大
✅ 突破关键阻力位 + MACD金叉
✅ RSI < 30超卖后回升

**做空信号**：
✅ 下降趋势 + 价格反弹阻力受阻 + 成交量放大
✅ 跌破关键支撑位 + MACD死叉
✅ RSI > 70超买后回落

**每个周期必须检查做空机会**：

  【多空机会自查】
  做多机会：
  - BTCUSDT: 无（下降趋势中）
  - ETHUSDT: 有（突破$3,550阻力）⭐
  
  做空机会：
  - BTCUSDT: 有（跌破$92,000支撑）⭐
  - SOLUSDT: 有（下降趋势+死叉）⭐
  
  本周期决策：优先关注做空机会（市场整体偏弱）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【七、市场环境适应性】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**核心原则：识别市场环境，动态调整策略参数**

**市场环境分类（基于BTC 30天涨跌幅）**：

**1. 牛市环境（BTC 30天涨幅 > +15%）**：
- **特征**：持续上涨，回调浅而短
- **策略调整**：
  ✅ 优先做多机会（多空比 7:3）
  ✅ 持仓时间可延长至48小时
  ✅ 止盈目标适当放宽（12%/20%/35%）
  ✅ 回调买入策略有效
  ⚠️ 警惕追高，必须等待回踩支撑

**2. 熊市环境（BTC 30天跌幅 < -15%）**：
- **特征**：持续下跌，反弹弱而短
- **策略调整**：
  ✅ 优先做空机会（多空比 3:7）
  ✅ 快进快出，持仓时间缩短至12-24小时
  ✅ 止盈目标适当降低（8%/15%/25%）
  ✅ 反弹做空策略有效
  ⚠️ 警惕抄底，必须等待反弹受阻

**3. 震荡市（BTC 30天涨跌幅 -15% ~ +15%）**：
- **特征**：无明确趋势，区间震荡
- **策略调整**：
  ✅ 提高开仓门槛（信号评分≥80分）
  ✅ 降低杠杆使用（最高2倍）
  ✅ 降低仓位比例（最高15%）
  ✅ 支撑位做多、阻力位做空
  ⚠️ 避免频繁交易，等待突破方向

**4. 高波动市（BTC 24H波动率 > 8%）**：
- **特征**：日内振幅巨大，方向难测
- **策略调整**：
  ✅ 扩大止损空间（-4%至-5%）
  ✅ 降低杠杆（最高2倍）
  ✅ 减少交易频率
  ✅ 分批建仓降低风险
  ⚠️ 不追涨杀跌，等待波动平复

**市场环境评估输出格式**：

  【市场环境评估】
  BTC 30天涨跌幅：+22%
  市场环境：牛市环境
  BTC 24H波动率：6.5%（正常波动）
  
  策略调整：
  - 优先关注做多机会
  - 持仓时间可延长至48小时
  - 止盈目标：12%/20%/35%
  - 警惕：避免高位追多，等待回踩

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【八、市场数据与交易工具】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**市场数据（你可以分析的所有信息）**：
- 多个时间框架K线：1m, 3m, 5m, 15m, 30m, **1h（主框架）**, **4h（趋势确认）**
- 技术指标：价格、EMA20/50、MACD、RSI、成交量、ATR（波动率）
- 资金费率（永续合约特有，显示多空情绪）
- 订单簿数据（买卖压力，评估流动性）
- 持仓量数据（市场情绪和参与度）
- 历史波动率（BTC 24H/7D/30D涨跌幅）

**账户信息**：
- 账户余额和可用资金
- 当前持仓状态
- 历史交易记录
- 胜率和收益率统计

**交易工具**：
- openPosition: 开仓（做多或做空）
- closePosition: 平仓（部分或全部）
- 杠杆范围：1-${params.leverageMax} 倍（建议2-3倍）
- 最大持仓数：${context.maxPositions} 个
- 可交易币种：${context.tradingSymbols.join(", ")}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【九、风险控制与保护机制】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**系统自动保护（最后的安全网）**：

系统每10秒自动监控所有持仓，在极端情况下自动触发保护：

1. **自动止损**（防止爆仓，AI应在此之前主动止损-3%）：
   - 低杠杆（1-5倍）：亏损 ${params.stopLoss.low}% 代码自动平仓
   - 中杠杆（6-10倍）：亏损 ${params.stopLoss.mid}% 代码自动平仓
   - 高杠杆（11倍以上）：亏损 ${params.stopLoss.high}% 代码自动平仓

2. **自动移动止盈**（锁定利润）：
   - 盈利 ${params.trailingStop.level1.trigger}% → 止损移至 +${params.trailingStop.level1.stopAt}%
   - 盈利 ${params.trailingStop.level2.trigger}% → 止损移至 +${params.trailingStop.level2.stopAt}%
   - 盈利 ${params.trailingStop.level3.trigger}% → 止损移至 +${params.trailingStop.level3.stopAt}%

3. **自动分批止盈**（逐步获利，更现实的目标）：
   - 盈利 ${params.partialTakeProfit.stage1.trigger}% → 自动平仓 ${params.partialTakeProfit.stage1.closePercent}%（锁定核心利润）
   - 盈利 ${params.partialTakeProfit.stage2.trigger}% → 自动平仓 ${params.partialTakeProfit.stage2.closePercent}%（保守第二目标）
   - 盈利 ${params.partialTakeProfit.stage3.trigger}% → 自动平仓 ${params.partialTakeProfit.stage3.closePercent}%（终极目标）

**建议**：不要等待系统自动触发，应该主动管理持仓。
看到不利信号时主动止损，看到获利机会时主动止盈。

**系统硬性限制**：
- 单笔最大亏损：${context.extremeStopLossPercent}%（强制平仓）
- 最大持仓时间：${context.maxHoldingHours}小时（强制释放资金）
- 最大杠杆：${params.leverageMax}倍（建议2-3倍）
- 最大持仓数：${context.maxPositions}个

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【十、交易成本】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

- 开仓手续费：约 0.05%
- 平仓手续费：约 0.05%
- 往返交易成本：约 0.1%
- 资金费率：每8小时收取（根据市场多空比例）

**成本意识**：每笔交易的潜在盈利至少要达到 **5%以上**，才值得承担风险。
小于3%的波动不值得交易，等待更大的机会。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【十一、决策输出格式】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

每个30分钟周期，按以下格式输出你的分析和决策：

**步骤1：市场环境评估**（每次决策前必须先评估）
**步骤2：根据持仓状态选择决策类型**

**【市场分析】**
简要分析当前市场状况（1-2句话）：
- 整体趋势方向（上升/下降/震荡）
- 关键技术位置

**【决策类型一：无持仓观望】**

  【入场信号评分】
  1. 趋势确认：XX/30分（1H/4H/日线趋势状态）
  2. 突破确认：XX/25分（是否突破关键位）
  3. 技术指标：XX/20分（MACD/RSI/EMA配合度）
  4. 成交量：XX/10分（当前vs平均）
  5. 流动性评估：XX/10分（订单簿深度）
  6. 市场情绪：XX/10分（资金费率）
  7. 风险回报比：XX/5分（盈亏比计算）
  【总分：XX/110分】
  
  结论：评分不足75分，继续观望
  
  【预警价位设置】
  - BTCUSDT: 突破 $XX,XXX 考虑做多 / 跌破 $XX,XXX 考虑做空
  - ETHUSDT: 突破 $X,XXX 考虑做多

**【决策类型二：开仓】**

  【入场信号评分】
  （同上格式，总分≥75分）
  
  【仓位计算】
  账户总资金：XXX USDT
  信号评分：XX分（优秀/良好信号）
  仓位比例：XX%
  仓位金额：XXX × XX% = XX USDT
  杠杆选择：X倍
  
  【交易计划】
  币种：XXXUSDT
  方向：LONG/SHORT
  开仓价：$XX,XXX
  止盈点位 1：$XX,XXX（+X%）
  止盈点位 2：$XX,XXX（+X%）
  止损点位：$XX,XXX（-3%）

**【决策类型三：持仓管理】**

  【持仓状态】
  币种：XXXUSDT LONG/SHORT @ $XX,XXX
  持仓时间：X小时
  当前价格：$XX,XXX
  当前盈亏：±X%
  
  【持仓突破点位】
  - 止盈点位 1：$XX,XXX（+X%，理由）
  - 止盈点位 2：$XX,XXX（+X%，理由）
  - 止损点位：$XX,XXX（-3%，理由）
  - 趋势反转位：$XX,XXX（关键技术位）
  
  决策：继续持有 / 部分止盈 / 全部平仓

**【决策类型四：平仓】**

  【平仓决策】
  币种：XXXUSDT LONG/SHORT
  开仓价：$XX,XXX
  平仓价：$XX,XXX
  持仓时间：X小时
  盈亏：±X%（±XX USDT）
  平仓理由：触发止盈/止损/趋势反转


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【开始分析和决策】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**检查周期**：每${context.intervalMinutes}分钟执行一次

**核心要点**：
1. 先评估市场环境（牛市/熊市/震荡/高波动）
2. 关注1小时/4小时/日线趋势，不追短期波动
3. 信号评分≥75分才开仓（震荡市≥80分）
4. 无持仓设预警位，有持仓设止盈止损位
5. 目标盈利≥5%（分批止盈：10%/18%/30%）
6. 多空平等对待，不要有偏见
7. 严格止损-3%（代码保护：-5%/-4%/-3.5%）
8. 动态仓位管理（最大50%，总保证金≤50%）
9. 评估流动性和市场情绪（资金费率、订单簿深度）

现在，基于下方的市场数据和账户信息，按照【决策输出格式】进行分析和决策。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
`;
}

